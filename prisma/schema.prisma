generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String?   // Optional for OAuth users
  name              String
  username          String    @unique

  // OAuth Login
  oauthProvider     String?   // "google", "facebook", or null for email/password
  oauthId           String?   // Google/Facebook user ID
  oauthAvatarUrl    String?   // Avatar from OAuth provider
  avatarUrl         String?
  coverImageUrl     String?
  bio               String?
  website           String?
  links             String    @default("{}")   // JSON: { instagram, twitter, linkedin, tiktok, youtube, facebook, custom }
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?

  // Subscription & Billing
  plan              String    @default("STARTER")
  planExpiresAt     DateTime?
  stripeCustomerId  String?   @unique

  // Credits & Balance
  aiCredits         Int       @default(100)
  freeCredits       Int       @default(100)  // Remaining signup bonus (email marketing only)
  balanceCents      Int       @default(0)

  // Referral Program
  referralCode      String?   @unique  // User's unique referral code (REF-XXXXXXXX)

  // Location
  country           String?
  region            String?

  // Settings
  timezone          String    @default("UTC")
  language          String    @default("en")
  theme             String    @default("SYSTEM")
  notificationPrefs String    @default("{}")
  dismissedBanners  String    @default("[]")  // JSON array of dismissed banner IDs

  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  deletedAt         DateTime?

  // Relations
  posts             Post[]
  comments          Comment[]
  likes             Like[]
  bookmarks         Bookmark[]
  followers         Follow[]  @relation("Following")
  following         Follow[]  @relation("Followers")
  campaigns         Campaign[]
  adCampaigns       AdCampaign[]
  contacts          Contact[]
  earnings          Earning[]
  payouts           Payout[]
  aiUsage           AIUsage[]
  notifications     Notification[]
  sessions          Session[]
  brandKits         BrandKit[]
  contentTemplates  ContentTemplate[]
  creditTransactions CreditTransaction[]
  invoices          Invoice[]
  designs           Design[]
  designFolders     DesignFolder[]
  designShares           DesignShare[]         @relation("DesignShareCreator")
  designCollaborations   DesignCollaborator[]  @relation("DesignCollaborator")
  designInvitations      DesignCollaborator[]  @relation("DesignCollaboratorInviter")
  designActivities       DesignActivity[]
  landingPages      LandingPage[]
  mediaFiles        MediaFile[]
  mediaFolders      MediaFolder[]
  generatedContents GeneratedContent[]
  commentLikes      CommentLike[]
  teamMemberships   TeamMember[]
  ownedTeams        Team[]
  contentVariants   ContentVariant[]
  whiteLabelConfigs WhiteLabelConfig[]
  marketingConfig   MarketingConfig?
  cartoonVideos     CartoonVideo[]
  cartoonProjects   CartoonProject[]
  automations       Automation[]
  coupons           Coupon[]
  referrals         Referral[]
  aiConversations   AIConversation[]
  postAutomations    PostAutomation[]
  marketingStrategies MarketingStrategy[]
  strategyScores      StrategyScore[]
  strategyMilestones  StrategyMilestone[]
  socialAccounts      SocialAccount[]
  agentProfile        AgentProfile?
  agentClients        AgentClient[]     @relation("ClientOfAgent")
  agentReviews        AgentReview[]     @relation("AgentReviews")
  referralsGiven      UserReferral[]    @relation("ReferrerUser")
  referralReceived    UserReferral?     @relation("ReferredUser")
  referralCommissions ReferralCommission[]
  followUps              FollowUp[]
  followUpAssignments    FollowUpEntry[]   @relation("FollowUpAssignee")
  surveys                Survey[]
  dataForms              DataForm[]
  events                 Event[]
  joinRequests           TeamJoinRequest[] @relation("JoinRequests")
  projectMemberships     ProjectMember[]
  contentFlags           ContentFlag[]  @relation("ContentFlagsReported")
  store                  Store?
  storeDomains           StoreDomain[]
  voiceProfiles          VoiceProfile[]
  voiceGenerations       VoiceGeneration[]
  whatsappConversations  WhatsAppConversation[]
  whatsappTemplates      WhatsAppTemplate[]
  whatsappAutomations    WhatsAppAutomation[]

  @@index([email])
  @@index([username])
  @@index([stripeCustomerId])
  @@index([referralCode])
  @@index([createdAt])
}

model SocialAccount {
  id                  String    @id @default(cuid())
  userId              String
  platform            String    // "instagram", "twitter", "linkedin", "facebook", "tiktok", "youtube", "pinterest", "threads", "whatsapp"
  platformUserId      String?   // The user's ID on the platform
  platformUsername    String?   // e.g. @username
  platformDisplayName String?   // Display name on the platform
  platformAvatarUrl   String?
  accessToken         String?   // OAuth access token (encrypted in production)
  refreshToken        String?   // OAuth refresh token (encrypted in production)
  tokenExpiresAt      DateTime?
  scopes              String    @default("[]") // JSON array of granted scopes
  isActive            Boolean   @default(true)
  connectedAt         DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Analytics fields
  followersCount      Int?      // Total followers/subscribers
  followingCount      Int?      // Total following (for platforms that have it)
  postsCount          Int?      // Total posts/videos/tweets
  engagementRate      Float?    // Average engagement rate (likes+comments/followers)
  impressions         Int?      // Total impressions (last 30 days)
  reach               Int?      // Total reach (last 30 days)
  profileViews        Int?      // Profile views (last 30 days)
  analyticsUpdatedAt  DateTime? // Last time analytics were fetched

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  whatsappConversations WhatsAppConversation[]
  whatsappTemplates     WhatsAppTemplate[]
  whatsappAutomations   WhatsAppAutomation[]

  @@unique([userId, platform])
  @@index([userId])
  @@index([platform])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model PasswordReset {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model EmailVerification {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// ============================================
// SOCIAL FEED (FLOWSOCIAL)
// ============================================

model Post {
  id           String     @id @default(cuid())
  userId       String

  // Content
  caption      String?
  hashtags     String     @default("[]")
  mentions     String     @default("[]")

  // Media
  mediaType    String?
  mediaUrl     String?
  thumbnailUrl String?
  mediaMeta    String?

  // Promotion
  isPromoted   Boolean    @default(false)
  campaignId   String?

  // Stats (denormalized for performance)
  likeCount    Int        @default(0)
  commentCount Int        @default(0)
  shareCount   Int        @default(0)
  viewCount    Int        @default(0)

  // Platforms for cross-posting
  platforms    String     @default("[]")  // JSON: ["feed", "instagram", "twitter"]

  // Social publishing results
  publishResults String?  // JSON: {"facebook": {"success": true, "postId": "..."}, "instagram": {...}}

  // Status
  status       String     @default("PUBLISHED")
  scheduledAt  DateTime?
  publishedAt  DateTime?

  // Metadata
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?

  // Moderation
  moderationStatus  String   @default("clean")
  moderationReason  String?
  flagCount         Int      @default(0)

  // Relations
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  adCampaign   AdCampaign? @relation(fields: [campaignId], references: [id])
  comments     Comment[]
  likes        Like[]
  bookmarks    Bookmark[]
  shares       Share[]
  postViews    PostView[]
  contentVariants ContentVariant[]
  contentFlags    ContentFlag[]

  @@index([userId])
  @@index([status, scheduledAt])
  @@index([isPromoted, status])
  @@index([createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  parentId  String?
  content   String

  likeCount Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // Moderation
  moderationStatus  String   @default("clean")
  moderationReason  String?
  flagCount         Int      @default(0)

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  commentLikes CommentLike[]
  contentFlags    ContentFlag[]

  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
}

model CommentLike {
  id        String   @id @default(cuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())

  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model Like {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Bookmark {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId, createdAt])
}

model Share {
  id        String   @id @default(cuid())
  postId    String
  platform  String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([platform])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ============================================
// PAID ADS & VIEW-TO-EARN
// ============================================

model AdCampaign {
  id              String   @id @default(cuid())
  userId          String

  name            String
  objective       String

  budgetCents     Int
  spentCents      Int      @default(0)
  dailyBudgetCents Int?
  cpvCents        Int

  targeting       String   @default("{}")

  startDate       DateTime
  endDate         DateTime?

  status          String   @default("DRAFT")

  impressions     Int      @default(0)
  clicks          Int      @default(0)
  conversions     Int      @default(0)

  // Ad type & content
  adType          String   @default("POST")     // POST, PRODUCT_LINK, LANDING_PAGE, EXTERNAL_URL
  destinationUrl  String?                        // Where clicks go (product/external URL)
  mediaUrl        String?                        // Ad creative image URL (S3)
  videoUrl        String?                        // Ad creative video URL (S3)
  headline        String?                        // Ad headline
  description     String?                        // Ad body text
  ctaText         String?  @default("Learn More") // CTA button text

  // Content policy
  adCategory      String?                        // E-commerce, SaaS, Health, Education, etc.
  contentRating   String   @default("GENERAL")   // GENERAL only (no explicit allowed)

  // Admin approval
  approvalStatus  String   @default("PENDING")   // PENDING, APPROVED, REJECTED
  reviewedAt      DateTime?
  reviewedBy      String?                        // Admin user ID
  rejectionReason String?

  // Quick ad page link
  adPageId        String?  @unique
  adPage          AdPage?  @relation(fields: [adPageId], references: [id])

  // Landing page link (for LANDING_PAGE type)
  landingPageId   String?
  landingPage     LandingPage? @relation(fields: [landingPageId], references: [id])

  // Google Ads integration
  googleAdsCampaignId  String?   // Google Ads campaign resource name
  googleAdsAdGroupId   String?   // Google Ads ad group resource name

  // Meta Ads integration
  metaAdsCampaignId    String?
  metaAdsAdSetId       String?

  // TikTok Ads integration
  tiktokAdsCampaignId  String?
  tiktokAdsAdGroupId   String?

  // E-commerce product promotion (Ad Bridge)
  sourceProductId      String?   // Product this campaign promotes
  sourceStoreId        String?   // Store this campaign is from
  revenueTrackedCents  Int       @default(0) // Total revenue attributed to this campaign
  adOrderCount         Int       @default(0) // Orders attributed to this campaign

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts           Post[]
  postViews       PostView[]

  @@index([userId])
  @@index([status, startDate, endDate])
  @@index([approvalStatus])
  @@index([adType])
  @@index([sourceProductId])
  @@index([sourceStoreId])
}

model AdPage {
  id              String   @id @default(cuid())
  slug            String   @unique
  headline        String
  description     String?
  mediaUrl        String?
  videoUrl        String?
  destinationUrl  String            // CTA redirect target
  ctaText         String   @default("Visit Now")
  templateStyle   String   @default("hero") // minimal, hero, split, video
  views           Int      @default(0)
  clicks          Int      @default(0)
  status          String   @default("ACTIVE")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  campaign        AdCampaign?

  @@index([slug])
  @@index([status])
}

model PostView {
  id           String      @id @default(cuid())
  postId       String
  viewerUserId String?
  campaignId   String?

  earnedCents  Int         @default(0)

  viewDuration Int
  deviceType   String?

  createdAt    DateTime    @default(now())

  post         Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  campaign     AdCampaign? @relation(fields: [campaignId], references: [id])

  @@unique([postId, viewerUserId])
  @@index([postId])
  @@index([viewerUserId])
  @@index([campaignId])
  @@index([createdAt])
}

model Earning {
  id          String   @id @default(cuid())
  userId      String

  amountCents Int
  source      String
  sourceId    String?

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([source])
  @@index([createdAt])
}

model Payout {
  id            String   @id @default(cuid())
  userId        String

  amountCents   Int
  method        String

  accountInfo   String   @default("{}")
  transactionId String?

  status        String   @default("PENDING")
  requestedAt   DateTime @default(now())
  processedAt   DateTime?
  failedReason  String?

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

// ============================================
// EMAIL & SMS CAMPAIGNS
// ============================================

model Campaign {
  id            String    @id @default(cuid())
  userId        String

  type          String
  name          String

  subject       String?
  preheaderText String?
  fromName      String?
  replyTo       String?

  content       String
  contentHtml   String?

  // MMS image
  imageUrl         String?
  imageSource      String?   // "upload" | "media" | "ai" | "contact_photo"
  imageOverlayText String?   // Text to composite on image (supports merge tags)

  contactListId String?
  segmentRules  String?

  sentCount      Int       @default(0)
  deliveredCount Int       @default(0)
  failedCount    Int       @default(0)
  openCount      Int       @default(0)
  clickCount     Int       @default(0)
  bounceCount    Int       @default(0)
  unsubCount     Int       @default(0)

  status        String    @default("DRAFT")
  scheduledAt   DateTime?
  sentAt        DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactList   ContactList? @relation(fields: [contactListId], references: [id])
  sends         CampaignSend[]

  @@index([userId])
  @@index([type, status])
}

model CampaignSend {
  id          String    @id @default(cuid())
  campaignId  String
  contactId   String

  messageId     String?   // Twilio message SID (SM...) for delivery tracking
  status        String    @default("PENDING") // PENDING, SENT, DELIVERED, FAILED, UNDELIVERED
  failureReason String?   // Twilio error code/message if failed/undelivered
  sentAt        DateTime?
  deliveredAt   DateTime?
  openedAt      DateTime?
  clickedAt     DateTime?
  bouncedAt     DateTime?

  opens       Int       @default(0)
  clicks      Int       @default(0)

  campaign    Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact     Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([campaignId, contactId])
  @@index([campaignId])
  @@index([contactId])
  @@index([status])
  @@index([messageId])
}

model ContactList {
  id        String    @id @default(cuid())
  userId    String
  name      String

  totalCount Int      @default(0)
  activeCount Int     @default(0)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  contacts    ContactListMember[]
  campaigns   Campaign[]
  automations Automation[]
  followUps   FollowUp[]
  surveys     Survey[]
  dataForms   DataForm[]
  events      Event[]

  @@index([userId])
}

model Contact {
  id              String    @id @default(cuid())
  userId          String

  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  birthday        String?    // "MM-DD" format for month/day matching (e.g. "02-14")
  company         String?    // Business/company name
  city            String?
  state           String?
  address         String?
  imageUrl        String?   // Contact photo URL (S3)

  customFields    String    @default("{}")
  tags            String    @default("[]")

  emailOptedIn    Boolean   @default(false)
  emailOptedInAt  DateTime?
  smsOptedIn      Boolean   @default(false)
  smsOptedInAt    DateTime?

  status          String    @default("ACTIVE")
  unsubscribedAt  DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lists           ContactListMember[]
  sends           CampaignSend[]

  coupons         Coupon[]
  referralsGiven  Referral[]   @relation("ReferrerContact")
  referralsUsed   Referral[]   @relation("ReferredContact")
  followUpEntries FollowUpEntry[]

  @@unique([userId, email])
  @@unique([userId, phone])
  @@index([userId])
  @@index([email])
  @@index([phone])
}

// ---------------------------------------------------------------------------
// Coupon System
// ---------------------------------------------------------------------------

model Coupon {
  id          String    @id @default(cuid())
  userId      String
  contactId   String?
  campaignId  String?
  code        String    @unique
  discount    String    // "10%" or "$5" or "20% OFF"
  expiresAt   DateTime?
  redeemedAt  DateTime?
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact     Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([code])
  @@index([contactId])
}

// ---------------------------------------------------------------------------
// Referral System
// ---------------------------------------------------------------------------

model Referral {
  id          String    @id @default(cuid())
  userId      String
  referrerId  String
  referredId  String?
  code        String    @unique
  status      String    @default("PENDING") // PENDING, COMPLETED, REWARDED
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  referrer    Contact   @relation("ReferrerContact", fields: [referrerId], references: [id], onDelete: Cascade)
  referred    Contact?  @relation("ReferredContact", fields: [referredId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([code])
  @@index([referrerId])
}

// ---------------------------------------------------------------------------
// User-to-User Referral Program
// ---------------------------------------------------------------------------

model UserReferral {
  id              String    @id @default(cuid())
  referrerUserId  String
  referredUserId  String    @unique  // One referral per user (can only be referred once)
  referralCode    String              // The code used at signup
  referralType    String              // "USER_TO_CLIENT", "AGENT_TO_CLIENT", "AGENT_TO_AGENT"
  status          String    @default("ACTIVE") // ACTIVE, EXPIRED, CANCELLED
  commissionRate  Float               // 0.05 for 5%, 0.50 for 50%
  commissionType  String              // "RECURRING" or "ONE_TIME"
  expiresAt       DateTime?           // When recurring commission period ends (3 months from signup)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  referrer        User @relation("ReferrerUser", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referred        User @relation("ReferredUser", fields: [referredUserId], references: [id], onDelete: Cascade)
  commissions     ReferralCommission[]

  @@index([referrerUserId])
  @@index([referredUserId])
  @@index([referralCode])
  @@index([status])
  @@index([expiresAt])
}

model ReferralCommission {
  id              String    @id @default(cuid())
  referralId      String
  referrerUserId  String
  amountCents     Int                 // Commission amount in cents
  sourcePaymentId String?             // Stripe payment/invoice ID that triggered this
  sourceType      String              // "SUBSCRIPTION", "CREDIT_PURCHASE", "AGENT_HIRE"
  status          String    @default("PENDING") // PENDING, PAID, CANCELLED
  paidAt          DateTime?
  createdAt       DateTime  @default(now())

  referral        UserReferral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  referrer        User @relation(fields: [referrerUserId], references: [id], onDelete: Cascade)

  @@index([referralId])
  @@index([referrerUserId])
  @@index([status])
  @@index([createdAt])
}

model ContactListMember {
  id            String      @id @default(cuid())
  contactListId String
  contactId     String
  addedAt       DateTime    @default(now())

  contactList   ContactList @relation(fields: [contactListId], references: [id], onDelete: Cascade)
  contact       Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([contactListId, contactId])
}

// ============================================
// AI USAGE TRACKING
// ============================================

model AIUsage {
  id           String   @id @default(cuid())
  userId       String?  // Optional - null for admin users
  adminId      String?  // For admin user tracking

  feature      String
  model        String

  inputTokens  Int
  outputTokens Int
  costCents    Int      @default(0)

  prompt       String?
  response     String?
  latencyMs    Int?

  createdAt    DateTime @default(now())

  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adminId])
  @@index([feature])
  @@index([createdAt])
}

// ============================================
// CREDIT PRICING (Admin Controlled)
// ============================================

model CreditPricing {
  id          String   @id @default(cuid())

  // Unique key for the pricing item (e.g., "AI_POST", "AI_LOGO_GENERATION")
  key         String   @unique

  // Display name for the pricing item
  name        String

  // Description of what this pricing is for
  description String?

  // Credit cost (how many credits this feature costs)
  credits     Int      @default(1)

  // Category for grouping in the admin UI
  category    String   @default("general") // "text_generation", "image_generation", "branding", "other"

  // Whether this pricing is active
  isActive    Boolean  @default(true)

  // Metadata (JSON for additional info like estimated API cost, etc.)
  metadata    String   @default("{}")

  // Tracking
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedBy   String?  // Admin who last updated this

  @@index([category])
  @@index([isActive])
}

// ============================================
// CREDIT TRANSACTIONS
// ============================================

model CreditTransaction {
  id           String   @id @default(cuid())
  userId       String

  // Transaction details
  type         String   // "PURCHASE", "USAGE", "BONUS", "REFUND", "ADMIN_ADJUSTMENT", "SUBSCRIPTION", "REFERRAL"
  amount       Int      // Positive for add, negative for deduct
  balanceAfter Int      // User's balance after this transaction

  // Reference info
  referenceType String? // "ai_usage", "purchase", "subscription", etc.
  referenceId   String? // ID of related record

  // For admin adjustments
  adminId      String?  // Admin who made the adjustment
  reason       String?  // Reason for adjustment

  // Metadata
  description  String?
  metadata     String   @default("{}")

  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([adminId])
}

// ============================================
// INVOICES
// ============================================

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique // e.g. INV-2026-0001
  userId        String

  // What was purchased
  type          String   // "credit_purchase", "subscription", "sms_rental"
  status        String   @default("PAID") // "PAID", "PENDING", "REFUNDED"

  // Line items (JSON array: [{description, quantity, unitPriceCents, totalCents}])
  items         String   @default("[]")

  // Totals (in cents)
  subtotalCents Int
  taxCents      Int      @default(0)
  totalCents    Int

  // Payment info
  paymentMethod String?  // "visa ****1234"
  paymentId     String?  // Stripe PaymentIntent ID
  currency      String   @default("USD")

  // Business details at time of invoice
  customerName  String?
  customerEmail String?

  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([status])
}

// ============================================
// SUBSCRIPTION PLANS
// ============================================

model Plan {
  id                    String   @id @default(cuid())

  // Basic info
  planId                String   @unique // STARTER, PRO, BUSINESS, ENTERPRISE
  name                  String
  description           String?

  // Pricing (in cents)
  priceCentsMonthly     Int      @default(0)
  priceCentsYearly      Int      @default(0)

  // Stripe Price IDs (required for paid plans)
  stripePriceIdMonthly  String?
  stripePriceIdYearly   String?
  stripeProductId       String?

  // Credits included
  monthlyCredits        Int      @default(0)

  // Features (JSON array)
  features              String   @default("[]")

  // Display
  isPopular             Boolean  @default(false)
  sortOrder             Int      @default(0)
  color                 String   @default("#0ea5e9") // For UI display
  icon                  String   @default("Sparkles") // Lucide icon name

  // Status
  isActive              Boolean  @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([isActive, sortOrder])
  @@index([planId])
}

// ============================================
// CREDIT PACKAGES (for purchases)
// ============================================

model CreditPackage {
  id           String   @id @default(cuid())

  // Unique identifier for lookup
  packageId    String   @unique

  name         String
  description  String?
  credits      Int      // Number of credits in package
  priceCents   Int      // Price in cents

  // Stripe info
  stripePriceId String?
  stripeProductId String?

  // Bonus/discount
  bonusCredits Int      @default(0)
  discountPercent Int   @default(0)

  // Display
  isPopular    Boolean  @default(false)
  sortOrder    Int      @default(0)

  // Status
  isActive     Boolean  @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive, sortOrder])
  @@index([packageId])
}

// ============================================
// CONTENT TEMPLATES
// ============================================

model ContentTemplate {
  id            String   @id @default(cuid())

  // Basic info
  name          String
  description   String
  category      String   // "social-post", "caption", "hashtags", "ideas", "thread"

  // Template content
  promptTemplate String  // The actual prompt template with placeholders like {{brand}}, {{topic}}

  // Visual
  icon          String   @default("Sparkles") // Lucide icon name
  color         String   @default("#0ea5e9") // Brand color
  previewImage  String?  // Optional preview image URL

  // Platform targeting
  platforms     String   @default("[]") // JSON array: ["instagram", "twitter", "linkedin"]

  // Default settings (JSON)
  defaultSettings String @default("{}") // tone, length, includeHashtags, etc.

  // Categorization
  tags          String   @default("[]") // JSON array for filtering

  // Ownership
  isSystem      Boolean  @default(false) // System templates vs user-created
  userId        String?  // null for system templates

  // Status
  isActive      Boolean  @default(true)
  isFeatured    Boolean  @default(false)

  // Usage tracking
  usageCount    Int      @default(0)

  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([isSystem, isActive])
  @@index([userId])
  @@index([isFeatured])
  @@index([usageCount])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(cuid())
  userId    String

  type      String
  title     String
  message   String
  data      String?

  actionUrl String?

  read      Boolean  @default(false)
  readAt    DateTime?

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}

// ============================================
// BRAND KITS
// ============================================

model BrandKit {
  id          String   @id @default(cuid())
  userId      String

  // Basic Info
  name        String                    // Brand/Business name
  tagline     String?                   // Brand tagline or slogan
  description String?                   // Brief brand description
  logo        String?                   // Full logo URL (text + icon, wide format)
  iconLogo    String?                   // Icon logo URL (square, used for social avatars & feeds)

  // Contact Information
  email       String?                   // Business email
  phone       String?                   // Business phone number
  website     String?                   // Website URL
  address     String?                   // Business address

  // Industry & Audience
  industry    String?                   // e.g., "SaaS", "Fashion", "Health & Fitness"
  niche       String?                   // More specific niche
  targetAudience String?                // Who the brand serves
  audienceAge String?                   // Target age range
  audienceLocation String?              // Geographic focus

  // Brand Voice & Personality
  voiceTone   String?                   // e.g., "Professional", "Casual", "Playful"
  personality String   @default("[]")   // JSON array: ["innovative", "friendly", "trustworthy"]
  keywords    String   @default("[]")   // JSON array of brand keywords
  avoidWords  String   @default("[]")   // JSON array of words to avoid

  // Visual Identity
  colors      String   @default("{}")   // JSON: {primary, secondary, accent}
  fonts       String   @default("{}")   // JSON: {heading, body}

  // Content Guidelines
  guidelines  String?                   // Detailed brand guidelines
  hashtags    String   @default("[]")   // JSON array of brand hashtags
  handles     String   @default("{}")   // JSON: {instagram, twitter, linkedin, etc.}

  // Products/Services
  products    String   @default("[]")   // JSON array of main products/services
  uniqueValue String?                   // Unique value proposition

  isDefault   Boolean  @default(false)
  isComplete  Boolean  @default(false)  // Has user completed setup

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDefault])
}

// ============================================
// AUDIT LOG (Enhanced)
// ============================================

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  sessionId    String?

  // Action details
  action       String
  category     String   @default("SYSTEM")
  severity     String   @default("INFO")

  // Resource tracking
  resourceType String?
  resourceId   String?

  // Request details
  method       String?
  path         String?
  statusCode   Int?
  duration     Int?

  // Location & Device
  ipAddress    String?
  country      String?
  city         String?
  region       String?
  latitude     Float?
  longitude    Float?

  // Device info
  userAgent    String?
  browser      String?
  browserVersion String?
  os           String?
  osVersion    String?
  device       String?
  deviceType   String?

  // Additional data
  metadata     String   @default("{}")
  oldValue     String?
  newValue     String?
  errorMessage String?

  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([action])
  @@index([category])
  @@index([severity])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([resourceType, resourceId])
}

// ============================================
// ADMIN USERS
// ============================================

model AdminUser {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String

  role         String   @default("ADMIN")
  permissions  String   @default("[]")

  isActive     Boolean  @default(true)
  isSuperAdmin Boolean  @default(false)

  lastLoginAt  DateTime?
  lastLoginIp  String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  createdBy    String?

  sessions     AdminSession[]

  @@index([email])
  @@index([role])
}

model AdminSession {
  id           String   @id @default(cuid())
  adminId      String
  token        String   @unique

  ipAddress    String?
  userAgent    String?
  country      String?
  city         String?

  expiresAt    DateTime
  createdAt    DateTime @default(now())

  admin        AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([token])
}

// ============================================
// AGENT MARKETPLACE
// ============================================

model AgentProfile {
  id                String    @id @default(cuid())
  userId            String    @unique
  displayName       String
  bio               String?
  specialties       String    @default("[]")  // JSON: ["Social Media", "Content Strategy"]
  industries        String    @default("[]")  // JSON: ["E-Commerce", "SaaS"]
  portfolioUrls     String    @default("[]")  // JSON: ["https://..."]
  coverImageUrl     String?                     // S3 URL for banner image
  showcaseImages    String    @default("[]")    // JSON: [{url, title, description}]
  minPricePerMonth  Int       @default(10000)   // cents ($100 minimum)

  // Approval status
  status            String    @default("PENDING") // PENDING, APPROVED, REJECTED, SUSPENDED
  approvedAt        DateTime?
  rejectedReason    String?

  // Performance
  performanceScore  Int       @default(0)     // 0-100
  totalEarningsCents Int      @default(0)
  clientCount       Int       @default(0)

  // Landing page
  landingPageSlug   String?   @unique
  landingPageData   String    @default("{}") // JSON: page builder data

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  clients           AgentClient[]
  warnings          AgentWarning[]
  sessions          AgentSession[]
  activityLogs      AgentActivityLog[]

  reviews           AgentReview[]

  @@index([userId])
  @@index([status])
  @@index([performanceScore])
  @@index([landingPageSlug])
}

model AgentReview {
  id              String    @id @default(cuid())
  agentProfileId  String
  reviewerUserId  String
  rating          Int                           // 1-5 stars
  comment         String                        // Review text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  agentProfile    AgentProfile @relation(fields: [agentProfileId], references: [id], onDelete: Cascade)
  reviewer        User         @relation("AgentReviews", fields: [reviewerUserId], references: [id], onDelete: Cascade)

  @@unique([agentProfileId, reviewerUserId])
  @@index([agentProfileId])
  @@index([reviewerUserId])
}

model AgentClient {
  id                String    @id @default(cuid())
  agentProfileId    String
  clientUserId      String

  // Relationship
  status            String    @default("PENDING") // PENDING, ACTIVE, PAUSED, TERMINATED
  monthlyPriceCents Int
  message           String?   // Client's message when requesting to hire
  agreedToTerms     Boolean   @default(false) // Client agreed to service agreement
  agentAgreedToTerms Boolean  @default(false) // Agent agreed on acceptance
  startDate         DateTime  @default(now())
  endDate           DateTime?
  warningCount      Int       @default(0)
  lastReviewedAt    DateTime?

  // Termination
  terminatedBy      String?   // "agent", "client", "system"
  terminationReason String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  agentProfile      AgentProfile @relation(fields: [agentProfileId], references: [id], onDelete: Cascade)
  clientUser        User         @relation("ClientOfAgent", fields: [clientUserId], references: [id], onDelete: Cascade)
  activityLogs      AgentActivityLog[]
  warnings          AgentWarning[]
  conversation      Conversation?
  approvalSettings  ApprovalSettings?

  @@unique([agentProfileId, clientUserId])
  @@index([agentProfileId])
  @@index([clientUserId])
  @@index([status])
}

// ============================================
// AGENT-CLIENT MESSAGING
// ============================================

model Conversation {
  id              String    @id @default(cuid())
  agentClientId   String?   @unique
  agentUserId     String?
  clientUserId    String?
  teamId          String?
  isGroup         Boolean   @default(false)
  lastMessageAt   DateTime  @default(now())
  lastMessageText String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  agentClient     AgentClient? @relation(fields: [agentClientId], references: [id], onDelete: Cascade)
  team            Team?        @relation(fields: [teamId], references: [id], onDelete: Cascade)
  messages        Message[]
  participants    ConversationParticipant[]
  readReceipts    MessageReadReceipt[]

  @@index([agentUserId, lastMessageAt])
  @@index([clientUserId, lastMessageAt])
  @@index([teamId, lastMessageAt])
}

model Message {
  id              String    @id @default(cuid())
  conversationId  String
  senderUserId    String
  type            String    @default("TEXT") // TEXT, MEDIA, APPROVAL_REQUEST
  text            String?
  attachments     String    @default("[]") // JSON: [{url, filename, mimeType, size, type}]
  readAt          DateTime? // null = unread by recipient (1:1 so single field suffices)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  conversation    Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  approvalRequest ContentApproval?

  @@index([conversationId, createdAt])
  @@index([conversationId, readAt])
}

model ContentApproval {
  id              String    @id @default(cuid())
  messageId       String    @unique
  conversationId  String
  postContent     String?
  mediaUrls       String    @default("[]") // JSON array of S3 URLs
  platforms       String    @default("[]") // JSON: ["instagram", "twitter", "feed"]
  scheduledAt     DateTime?
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED
  reviewComment   String?
  reviewedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  message         Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([conversationId, status])
}

model ApprovalSettings {
  id                          String    @id @default(cuid())
  agentClientId               String    @unique
  requireApproval             String    @default("ALL") // ALL, MEDIA_ONLY, PLATFORM_SPECIFIC, NONE
  platformsRequiringApproval  String    @default("[]") // JSON: ["instagram", "twitter"]
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt

  agentClient     AgentClient @relation(fields: [agentClientId], references: [id], onDelete: Cascade)
}

model AgentSession {
  id                String    @id @default(cuid())
  agentProfileId    String
  clientUserId      String
  token             String    @unique
  reason            String?   // Why the agent is logging in
  expiresAt         DateTime
  endedAt           DateTime?

  createdAt         DateTime  @default(now())

  agentProfile      AgentProfile @relation(fields: [agentProfileId], references: [id], onDelete: Cascade)

  @@index([agentProfileId])
  @@index([token])
  @@index([clientUserId])
}

model AgentActivityLog {
  id                String    @id @default(cuid())
  agentClientId     String?
  agentProfileId    String
  action            String    // "post_created", "campaign_sent", "content_generated", etc.
  resourceType      String?   // "post", "campaign", "automation"
  resourceId        String?
  description       String?

  createdAt         DateTime  @default(now())

  agentClient       AgentClient?  @relation(fields: [agentClientId], references: [id], onDelete: SetNull)
  agentProfile      AgentProfile  @relation(fields: [agentProfileId], references: [id], onDelete: Cascade)

  @@index([agentClientId])
  @@index([agentProfileId])
  @@index([createdAt])
}

model AgentWarning {
  id                String    @id @default(cuid())
  agentProfileId    String
  agentClientId     String?
  level             String    @default("FIRST") // FIRST, FINAL
  reason            String
  details           String    @default("{}") // JSON: performance data
  isResolved        Boolean   @default(false)
  resolvedAt        DateTime?
  resolvedBy        String?   // Admin ID
  clientDecision    String?   // CONTINUE, TERMINATE (for FINAL warnings)
  clientDecidedAt   DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  agentProfile      AgentProfile  @relation(fields: [agentProfileId], references: [id], onDelete: Cascade)
  agentClient       AgentClient?  @relation(fields: [agentClientId], references: [id], onDelete: SetNull)

  @@index([agentProfileId])
  @@index([agentClientId])
  @@index([level, isResolved])
}

// ============================================
// PAGE ANALYTICS (Google Analytics Style)
// ============================================

model PageView {
  id           String   @id @default(cuid())
  visitorId    String
  sessionId    String
  userId       String?

  // Page info
  path         String
  title        String?
  referrer     String?

  // UTM tracking
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?
  utmTerm      String?
  utmContent   String?

  // Timing
  loadTime     Int?
  timeOnPage   Int?

  // Location
  ipAddress    String?
  country      String?
  countryCode  String?
  city         String?
  region       String?
  latitude     Float?
  longitude    Float?
  timezone     String?

  // Device info
  userAgent    String?
  browser      String?
  browserVersion String?
  os           String?
  osVersion    String?
  device       String?
  deviceType   String?
  screenWidth  Int?
  screenHeight Int?
  language     String?

  createdAt    DateTime @default(now())

  visitor      Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@index([visitorId])
  @@index([sessionId])
  @@index([userId])
  @@index([path])
  @@index([createdAt])
  @@index([country])
  @@index([deviceType])
}

model VisitorSession {
  id           String   @id @default(cuid())
  visitorId    String

  startedAt    DateTime @default(now())
  endedAt      DateTime?

  // Session metrics
  pageViews    Int      @default(0)
  duration     Int      @default(0)
  bounced      Boolean  @default(true)

  // Entry/Exit
  entryPage    String?
  exitPage     String?

  // Source
  referrer     String?
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?

  // Location
  country      String?
  city         String?

  // Device
  deviceType   String?
  browser      String?
  os           String?

  visitor      Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@index([visitorId])
  @@index([startedAt])
  @@index([country])
}

// ============================================
// VISITOR TRACKING (Pixel System)
// ============================================

model Visitor {
  id           String   @id @default(cuid())

  // Collected contact info
  email        String?
  phone        String?
  firstName    String?
  lastName     String?
  company      String?

  // Identification
  userId       String?  @unique
  fingerprint  String?

  // Location (from IP)
  ipAddress    String?
  country      String?
  countryCode  String?
  city         String?
  region       String?
  postalCode   String?
  latitude     Float?
  longitude    Float?
  timezone     String?
  isp          String?

  // Device info
  userAgent    String?
  browser      String?
  browserVersion String?
  os           String?
  osVersion    String?
  device       String?
  deviceType   String?
  screenWidth  Int?
  screenHeight Int?
  language     String?

  // Tracking
  firstSeenAt  DateTime @default(now())
  lastSeenAt   DateTime @default(now())
  totalVisits  Int      @default(1)
  totalPageViews Int    @default(0)

  // Source tracking
  firstReferrer String?
  firstUtmSource String?
  firstUtmMedium String?
  firstUtmCampaign String?

  // Lead scoring
  leadScore    Int      @default(0)
  tags         String   @default("[]")

  // Consent
  cookieConsent Boolean @default(false)
  marketingConsent Boolean @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  pageViews    PageView[]
  sessions     VisitorSession[]
  events       TrackingEvent[]

  @@index([email])
  @@index([phone])
  @@index([fingerprint])
  @@index([userId])
  @@index([country])
  @@index([firstSeenAt])
  @@index([lastSeenAt])
}

model TrackingEvent {
  id           String   @id @default(cuid())
  visitorId    String
  sessionId    String?
  userId       String?

  // Event details
  eventName    String
  eventCategory String?
  eventLabel   String?
  eventValue   Float?

  // Page context
  path         String?

  // Custom properties
  properties   String   @default("{}")

  createdAt    DateTime @default(now())

  visitor      Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@index([visitorId])
  @@index([sessionId])
  @@index([eventName])
  @@index([eventCategory])
  @@index([createdAt])
}

// ============================================
// REAL-TIME ANALYTICS
// ============================================

model RealtimeVisitor {
  id           String   @id @default(cuid())
  visitorId    String
  sessionId    String

  currentPath  String

  country      String?
  city         String?
  deviceType   String?

  lastActiveAt DateTime @default(now())

  @@index([lastActiveAt])
  @@index([currentPath])
}

// ============================================
// ANALYTICS AGGREGATES (for performance)
// ============================================

model AnalyticsDaily {
  id           String   @id @default(cuid())
  date         DateTime

  // Metrics
  pageViews    Int      @default(0)
  uniqueVisitors Int    @default(0)
  sessions     Int      @default(0)
  bounceRate   Float    @default(0)
  avgSessionDuration Int @default(0)
  avgPageViews Float    @default(0)

  // Top pages (JSON array)
  topPages     String   @default("[]")

  // Traffic sources
  topReferrers String   @default("[]")
  topCountries String   @default("[]")
  topDevices   String   @default("[]")
  topBrowsers  String   @default("[]")

  createdAt    DateTime @default(now())

  @@unique([date])
  @@index([date])
}

model AnalyticsPageDaily {
  id           String   @id @default(cuid())
  date         DateTime
  path         String

  pageViews    Int      @default(0)
  uniqueVisitors Int    @default(0)
  avgTimeOnPage Int     @default(0)
  bounceRate   Float    @default(0)
  entrances    Int      @default(0)
  exits        Int      @default(0)

  @@unique([date, path])
  @@index([date])
  @@index([path])
}

// ============================================
// VISUAL DESIGNS (AI Studio)
// ============================================

model Design {
  id          String         @id @default(cuid())
  userId      String
  prompt      String
  category    String         // social_post, ad, flyer, poster, banner, signboard
  size        String         // e.g., "1080x1080"
  style       String?        // e.g., "photorealistic", "illustration", "minimalist"
  imageUrl    String?
  name        String         @default("Untitled Design")
  type        String         @default("image") // "image" | "video_project"
  canvasData  String?        // Fabric.js JSON or video project JSON serialization
  status      String         @default("PENDING") // PENDING, GENERATING, COMPLETED, FAILED
  metadata    String         @default("{}")
  folderId    String?
  folder      DesignFolder?  @relation(fields: [folderId], references: [id], onDelete: SetNull)

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  shares         DesignShare[]
  collaborators  DesignCollaborator[]
  activities     DesignActivity[]

  @@index([userId])
  @@index([category])
  @@index([createdAt])
  @@index([folderId])
}

model DesignFolder {
  id        String          @id @default(cuid())
  userId    String
  name      String
  parentId  String?
  parent    DesignFolder?   @relation("DesignFolderTree", fields: [parentId], references: [id])
  children  DesignFolder[]  @relation("DesignFolderTree")
  designs   Design[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([parentId])
}

model DesignShare {
  id          String    @id @default(cuid())
  designId    String
  token       String    @unique
  permission  String    @default("VIEW") // VIEW, EDIT, COPY
  createdBy   String
  label       String?
  expiresAt   DateTime?
  maxUses     Int?
  useCount    Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  design      Design    @relation(fields: [designId], references: [id], onDelete: Cascade)
  creator     User      @relation("DesignShareCreator", fields: [createdBy], references: [id])

  @@index([designId])
  @@index([token])
}

model DesignCollaborator {
  id          String    @id @default(cuid())
  designId    String
  userId      String
  role        String    @default("VIEWER") // VIEWER, EDITOR
  invitedBy   String
  inviteEmail String?
  inviteToken String?   @unique
  status      String    @default("PENDING") // PENDING, ACCEPTED, DECLINED
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  design      Design    @relation(fields: [designId], references: [id], onDelete: Cascade)
  user        User      @relation("DesignCollaborator", fields: [userId], references: [id])
  inviter     User      @relation("DesignCollaboratorInviter", fields: [invitedBy], references: [id])

  @@unique([designId, userId])
  @@index([designId])
  @@index([inviteToken])
}

model DesignActivity {
  id          String    @id @default(cuid())
  designId    String
  userId      String
  action      String // VIEWED, EDITED, SHARED, DUPLICATED, INVITED, JOINED
  details     String    @default("{}")
  createdAt   DateTime  @default(now())

  design      Design    @relation(fields: [designId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id])

  @@index([designId])
  @@index([userId])
}

// ============================================
// LANDING PAGES
// ============================================

model LandingPage {
  id            String    @id @default(cuid())
  userId        String
  title         String
  slug          String    @unique
  description   String?
  pageType      String
  prompt        String
  htmlContent   String
  status        String    @default("DRAFT")
  thumbnailUrl  String?
  settings      String    @default("{}")
  formConfig    String    @default("{}")  // JSON: form field definitions for lead capture
  publishedAt   DateTime?
  views         Int       @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  formSubmissions FormSubmission[]
  adCampaigns     AdCampaign[]

  @@index([userId])
  @@index([slug])
  @@index([status])
}

model FormSubmission {
  id            String   @id @default(cuid())
  landingPageId String
  contactId     String?
  data          String   @default("{}")  // JSON: all submitted form fields
  source        String?                   // e.g. "landing-page"
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())

  landingPage   LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@index([landingPageId])
  @@index([contactId])
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSetting {
  id           String   @id @default(cuid())
  key          String   @unique
  value        String
  type         String   @default("string")
  category     String   @default("general")
  description  String?
  isPublic     Boolean  @default(false)

  updatedAt    DateTime @updatedAt
  updatedBy    String?

  @@index([category])
}

// ============================================
// GENERATED CONTENT LIBRARY
// ============================================

model GeneratedContent {
  id           String   @id @default(cuid())
  userId       String

  // Content type: "post", "caption", "hashtags", "ideas", "auto"
  type         String
  // The generated text content
  content      String
  // The prompt/topic used
  prompt       String

  // Platform targeting
  platforms    String   @default("[]")  // JSON array: ["instagram", "twitter"]

  // Generation settings
  settings     String   @default("{}")  // JSON: tone, length, etc.

  // Metadata
  metadata     String   @default("{}")  // JSON: extra context

  // Status
  isFavorite   Boolean  @default(false)
  isUsed       Boolean  @default(false) // User has used/posted this content

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([isFavorite])
  @@index([createdAt])
}

// ============================================
// MEDIA LIBRARY
// ============================================

model MediaFolder {
  id        String        @id @default(cuid())
  userId    String
  name      String
  parentId  String?
  parent    MediaFolder?  @relation("FolderTree", fields: [parentId], references: [id])
  children  MediaFolder[] @relation("FolderTree")
  files     MediaFile[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([parentId])
}

model MediaFile {
  id           String       @id @default(cuid())
  userId       String
  filename     String
  originalName String
  url          String
  type         String       // "image", "video", "document", "svg"
  mimeType     String
  size         Int
  width        Int?
  height       Int?
  folderId     String?
  tags         String       @default("[]")
  metadata     String       @default("{}")
  folder       MediaFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([folderId])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// TEAM COLLABORATION
// ============================================

model Team {
  id          String       @id @default(cuid())
  name        String
  slug        String       @unique
  description String?
  avatarUrl   String?
  ownerId     String
  owner        User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  members      TeamMember[]
  invitations  TeamInvitation[]
  joinRequests TeamJoinRequest[]
  projects     Project[]
  conversations Conversation[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([ownerId])
  @@index([slug])
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      String   @default("MEMBER") // OWNER, ADMIN, EDITOR, MEMBER
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model TeamInvitation {
  id          String    @id @default(cuid())
  teamId      String
  email       String
  role        String    @default("MEMBER") // ADMIN, EDITOR, MEMBER
  token       String    @unique
  status      String    @default("PENDING") // PENDING, ACCEPTED, EXPIRED, CANCELLED
  invitedBy   String
  acceptedAt  DateTime?
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email])
  @@index([token])
  @@index([email])
  @@index([teamId])
}

// ============================================
// TEAM PROJECTS & TASKS
// ============================================

model Project {
  id             String    @id @default(cuid())
  teamId         String
  name           String
  description    String?
  brief          String?
  status         String    @default("ACTIVE") // ACTIVE, COMPLETED, ARCHIVED
  deadline       DateTime?
  totalTasks     Int       @default(0)
  completedTasks Int       @default(0)
  createdBy      String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  team           Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  tasks          ProjectTask[]
  members        ProjectMember[]

  @@index([teamId])
  @@index([status])
  @@index([createdBy])
}

model ProjectMember {
  id              String    @id @default(cuid())
  projectId       String
  userId          String
  addedAt         DateTime  @default(now())
  creditAllowance Int       @default(0)
  creditsUsed     Int       @default(0)
  canActOnBehalf  Boolean   @default(false)
  expiresAt       DateTime?
  isRevoked       Boolean   @default(false)
  revokedAt       DateTime?

  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissions     MemberPermission[]

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model MemberPermission {
  id              String        @id @default(cuid())
  projectMemberId String
  featureKey      String
  maxUsage        Int           @default(-1)
  usedCount       Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  projectMember   ProjectMember @relation(fields: [projectMemberId], references: [id], onDelete: Cascade)

  @@unique([projectMemberId, featureKey])
  @@index([projectMemberId])
}

model ProjectTask {
  id          String    @id @default(cuid())
  projectId   String
  title       String
  description String?
  status      String    @default("TODO") // TODO, IN_PROGRESS, REVIEW, DONE
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH
  assigneeId  String?
  createdById String
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?
  sortOrder   Int       @default(0)
  progress    Int       @default(0)
  attachments String    @default("[]") // JSON: [{url, filename, mimeType, size}]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  comments    TaskComment[]

  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
}

model TaskComment {
  id          String      @id @default(cuid())
  taskId      String
  userId      String
  content     String
  attachments String      @default("[]")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  task        ProjectTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
}

// ============================================
// TEAM CONVERSATION SUPPORT
// ============================================

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

model MessageReadReceipt {
  id             String       @id @default(cuid())
  conversationId String
  messageId      String
  userId         String
  readAt         DateTime     @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([conversationId, userId])
}

// ============================================
// A/B TESTING
// ============================================

model ContentVariant {
  id            String   @id @default(cuid())
  userId        String
  postId        String
  variantLabel  String   // "A", "B", "C", etc.
  content       String
  headline      String?
  imageUrl      String?
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  conversions   Int      @default(0)
  engagementRate Float   @default(0)
  isWinner      Boolean  @default(false)
  isActive      Boolean  @default(true)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post          Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([postId])
  @@index([isActive])
}

// ============================================
// WHITE-LABEL SUPPORT
// ============================================

model WhiteLabelConfig {
  id              String  @id @default(cuid())
  userId          String
  domain          String? @unique
  appName         String  @default("FlowSmartly")
  logoUrl         String?
  faviconUrl      String?
  primaryColor    String  @default("#f97316")
  secondaryColor  String  @default("#0ea5e9")
  accentColor     String  @default("#8b5cf6")
  customCss       String?
  footerText      String?
  supportEmail    String?
  isActive        Boolean @default(false)
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([domain])
}

// ============================================
// EMAIL & SMS MARKETING CONFIGURATION
// ============================================

model MarketingConfig {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Email Provider Configuration
  emailProvider   String   @default("NONE") // NONE, SMTP, SENDGRID, MAILGUN, AMAZON_SES, RESEND
  emailConfig     String   @default("{}") // JSON: host, port, user, pass, apiKey, domain, fromEmail, fromName
  emailVerified   Boolean  @default(false)
  emailEnabled    Boolean  @default(false)

  // SMS Provider Configuration (Twilio through platform)
  smsEnabled      Boolean  @default(false)
  smsPhoneNumber  String?  // Rented Twilio number
  smsPhoneNumberSid String? // Twilio phone number SID
  smsVerified     Boolean  @default(false)

  // Pricing/Usage (cents per message)
  emailPricePerSend  Int   @default(0) // Platform markup added to base cost
  smsPricePerSend    Int   @default(5) // Price in cents (base + markup)

  // Monthly limits
  emailMonthlyLimit  Int   @default(1000)
  smsMonthlyLimit    Int   @default(500)

  // Current usage
  emailSentThisMonth Int   @default(0)
  smsSentThisMonth   Int   @default(0)
  usageResetDate     DateTime @default(now())

  // Sender defaults
  defaultFromName    String?
  defaultFromEmail   String?
  defaultReplyTo     String?

  // SMS Compliance (A2P / TCPA)
  smsComplianceStatus     String   @default("NOT_STARTED") // NOT_STARTED, PENDING_REVIEW, APPROVED, REJECTED, SUSPENDED
  businessName            String?
  businessWebsite         String?
  privacyPolicyUrl        String?
  termsOfServiceUrl       String?
  smsUseCase              String?  // Marketing, Support, Notifications, Mixed
  smsUseCaseDescription   String?
  smsMessageSamples       String   @default("[]") // JSON array of sample messages
  complianceSubmittedAt   DateTime?
  complianceReviewedAt    DateTime?
  complianceReviewedBy    String?
  complianceNotes         String?  // Admin notes for rejection/approval
  optOutMessage           String   @default("Reply STOP to unsubscribe")

  // Business Address (required for toll-free verification)
  businessStreetAddress   String?
  businessCity            String?
  businessStateProvinceRegion String?
  businessPostalCode      String?
  businessCountry         String?  @default("US")

  // Opt-in proof (screenshot URL showing how users consent to SMS)
  smsOptInImageUrl        String?

  // Toll-Free Verification
  smsTollfreeVerifySid    String?  // Toll-free verification SID (e.g. TF...)
  smsTollfreeVerifyStatus String?  // PENDING_REVIEW, IN_REVIEW, TWILIO_APPROVED, TWILIO_REJECTED

  // A2P 10DLC Registration (required for US local numbers)
  smsA2pBrandSid            String?  // Brand Registration SID (BN...)
  smsA2pBrandStatus         String?  // PENDING, APPROVED, FAILED, IN_REVIEW
  smsA2pCampaignSid         String?  // A2P Campaign SID (QE...)
  smsA2pCampaignStatus      String?  // PENDING, VERIFIED, FAILED, IN_PROGRESS
  smsA2pMessagingServiceSid String?  // Messaging Service SID (MG...)
  smsA2pProfileSid          String?  // Trust Hub Customer Profile Bundle SID (BU...)

  // Emergency Address (E911)  avoids $75/call surcharge
  smsEmergencyAddressSid  String?  // Twilio Address SID assigned to the phone number

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// CARTOON MAKER (AI Animated Video Generator)
// ============================================

model CartoonProject {
  id            String   @id @default(cuid())
  userId        String

  // Project Info
  name          String
  description   String?

  // Saved Characters (JSON array)
  characters    String   @default("[]")  // [{ name, role, description, visualAppearance }]

  // Default Settings
  style         String   @default("pixar")
  defaultDuration Int    @default(60)

  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  videos        CartoonVideo[]

  @@index([userId])
  @@index([createdAt])
}

model CartoonVideo {
  id            String   @id @default(cuid())
  userId        String
  projectId     String?  // Optional link to a project for series

  // Input
  storyPrompt   String
  style         String   @default("anime")    // anime, comic, watercolor, cartoon2d, flatdesign, pixar, clay, lowpoly
  animationType String   @default("static")   // static (Ken Burns), animated (Meta Animated Drawings)
  duration      Int      @default(60)         // 30, 60, 90 seconds
  captionStyle  String   @default("classic")  // none, classic, bold_pop, boxed, cinematic, colorful

  // Processing Status
  status        String   @default("PENDING")  // PENDING, PROCESSING, SCRIPT_READY, AWAITING_APPROVAL, APPROVED, IMAGES_READY, AUDIO_READY, COMPOSITING, COMPLETED, FAILED
  progress      Int      @default(0)          // 0-100
  currentStep   String?
  errorMessage  String?

  // Generated Content (JSON)
  script        String?   // { title, characters: [...], scenes: [{ sceneNumber, narration, visualDescription, duration }] }
  sceneImages   String?   // [{ sceneNumber, imageUrl }]
  audioFiles    String?   // [{ sceneNumber, audioUrl, durationMs }]

  // Output
  videoUrl      String?
  thumbnailUrl  String?
  videoDuration Int?      // Duration in seconds

  // Metadata
  creditsCost   Int       @default(60)
  metadata      String    @default("{}")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  completedAt   DateTime?

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  project       CartoonProject? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// AI CHAT ASSISTANT (FlowAI)
// ============================================

model AIConversation {
  id        String   @id @default(cuid())
  userId    String
  title     String   @default("New Conversation")
  summary   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  AIMessage[]

  @@index([userId])
  @@index([updatedAt])
}

model AIMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // "user" or "assistant"
  content        String
  tokensUsed     Int      @default(0)
  mediaType      String?  // "image", "video", null for text
  mediaUrl       String?  // S3 URL for generated media
  createdAt      DateTime @default(now())

  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

//  Email Marketing Automations 

model Automation {
  id            String    @id @default(cuid())
  userId        String

  name          String
  type          String    // BIRTHDAY, HOLIDAY, WELCOME, RE_ENGAGEMENT, CUSTOM
  trigger       String    @default("{}")  // JSON: { holidayId, conditions }

  enabled       Boolean   @default(false)

  // Campaign template
  campaignType  String    // EMAIL or SMS
  subject       String?
  content       String    @default("")
  contentHtml   String?

  // MMS image
  imageUrl         String?
  imageSource      String?   // "upload" | "media" | "ai" | "contact_photo"
  imageOverlayText String?

  // Timing
  sendTime      String    @default("09:00")  // HH:MM format
  daysOffset    Int       @default(0)        // -1 = day before, 0 = same day, 1 = day after
  timezone      String    @default("UTC")

  // Targeting
  contactListId String?   // Optional: limit to specific list, null = all contacts

  // Stats
  totalSent     Int       @default(0)
  lastTriggered DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactList   ContactList?  @relation(fields: [contactListId], references: [id])
  logs          AutomationLog[]

  @@index([userId])
  @@index([enabled, type])
}

model AutomationLog {
  id            String    @id @default(cuid())
  automationId  String
  contactId     String?
  status        String    // SENT, FAILED, SKIPPED
  error         String?
  sentAt        DateTime  @default(now())

  automation    Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([sentAt])
}

// ============================================
// CONTENT HUB  POST AUTOMATION & MARKETING STRATEGY
// ============================================

model PostAutomation {
  id            String    @id @default(cuid())
  userId        String

  name          String
  type          String    // RECURRING, EVENT_BASED, AI_GENERATED
  enabled       Boolean   @default(false)

  // Schedule config (JSON)
  schedule      String    @default("{}")  // { frequency: "weekly", dayOfWeek: 1, time: "09:00" }

  // AI content config
  topic         String?               // Topic / niche for AI content
  aiPrompt      String?
  aiTone        String    @default("professional")

  // Media generation options
  includeMedia    Boolean   @default(false)
  mediaType       String?                       // "image" | "video"
  mediaStyle      String?                       // "photorealistic", "illustration", etc.

  // Targeting
  platforms     String    @default("[]") // JSON: ["feed", "instagram", "twitter"]

  // Duration & budget control
  startDate       DateTime  @default(now())
  endDate         DateTime?

  // Strategy link (when created from strategy automation)
  strategyTaskId    String?   // Links to originating StrategyTask
  sourceStrategyId  String?   // Which strategy this came from

  // Stats
  totalGenerated    Int      @default(0)
  totalCreditsSpent Int      @default(0)
  lastTriggered     DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([enabled, type])
  @@index([endDate])
  @@index([strategyTaskId])
  @@index([sourceStrategyId])
}

model MarketingStrategy {
  id            String    @id @default(cuid())
  userId        String

  name          String
  description   String?
  status        String    @default("ACTIVE")  // ACTIVE, PAUSED, ARCHIVED
  aiGenerated   Boolean   @default(false)

  // Overall progress
  totalTasks    Int       @default(0)
  completedTasks Int      @default(0)

  // Activity sync
  lastActivitySync DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks         StrategyTask[]
  scores        StrategyScore[]
  milestones    StrategyMilestone[]

  @@index([userId])
  @@index([userId, status])
}

model StrategyTask {
  id            String    @id @default(cuid())
  strategyId    String

  title         String
  description   String?
  status        String    @default("TODO")  // TODO, IN_PROGRESS, DONE
  priority      String    @default("MEDIUM") // LOW, MEDIUM, HIGH
  category      String?   // content, social, ads, email, analytics

  // Timeline
  startDate     DateTime?
  dueDate       DateTime?
  completedAt   DateTime?

  // Ordering
  sortOrder     Int       @default(0)

  // AI tracking
  aiSuggested   Boolean   @default(false)
  autoCompleted Boolean   @default(false)

  // Automation tracking
  automationStatus  String    @default("NONE")  // NONE, AUTOMATABLE, AUTOMATED, MANUAL_ONLY
  automationId      String?   // Links to created PostAutomation

  // Activity matching
  progress          Int       @default(0)    // 0-100 completion percentage
  matchedActivities String    @default("[]") // JSON: [{activityType, activityId, matchedAt, confidence, matchReason}]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  strategy      MarketingStrategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  @@index([strategyId])
  @@index([status])
  @@index([dueDate])
}

model StrategyScore {
  id               String   @id @default(cuid())
  userId           String
  strategyId       String

  month            Int      // 1-12
  year             Int      // e.g. 2026

  overallScore     Int      @default(0)
  completionScore  Int      @default(0)
  onTimeScore      Int      @default(0)
  consistencyScore Int      @default(0)
  adherenceScore   Int      @default(0)
  productionScore  Int      @default(0)

  rawData          String   @default("{}")  // JSON audit data
  aiInsights       String?  // AI analysis text
  aiAreas          String?  // JSON: ["area1", "area2"]
  previousScore    Int?     // Previous month's overall for trend

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy         MarketingStrategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  @@unique([userId, strategyId, month, year])
  @@index([userId])
  @@index([strategyId])
  @@index([year, month])
}

model StrategyMilestone {
  id             String   @id @default(cuid())
  userId         String
  strategyId     String

  milestoneKey   String   // FIRST_TASK, 25_PERCENT, 50_PERCENT, etc.
  title          String
  description    String
  icon           String   @default("Trophy")

  sharedToFeed   Boolean  @default(false)
  sharedPostId   String?

  achievedAt     DateTime @default(now())

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy       MarketingStrategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  @@unique([userId, strategyId, milestoneKey])
  @@index([userId])
  @@index([strategyId])
  @@index([achievedAt])
}

// ============================================
// TOOLS  FOLLOW-UP TRACKER & SURVEYS
// ============================================

model FollowUp {
  id               String    @id @default(cuid())
  userId           String
  name             String
  description      String?
  type             String    @default("TRACKER") // TRACKER | SURVEY
  status           String    @default("ACTIVE")  // ACTIVE | PAUSED | COMPLETED | ARCHIVED
  contactListId    String?
  settings         String    @default("{}") // JSON config
  totalEntries     Int       @default(0)
  completedEntries Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  shareSlug        String?      @unique
  shareEnabled     Boolean      @default(false)

  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactList      ContactList? @relation(fields: [contactListId], references: [id], onDelete: SetNull)
  entries          FollowUpEntry[]
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model FollowUpEntry {
  id             String    @id @default(cuid())
  followUpId     String
  contactId      String?
  assigneeId     String?
  name           String?
  phone          String?
  email          String?
  address        String?
  referralSource String?
  status         String    @default("PENDING") // PENDING | CALLED | NO_ANSWER | CALLBACK | COMPLETED | DECLINED | NOT_INTERESTED
  notes          String?
  callDate       DateTime?
  nextFollowUp   DateTime?
  attempts       Int       @default(0)
  customData     String    @default("{}") // JSON
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  followUp       FollowUp  @relation(fields: [followUpId], references: [id], onDelete: Cascade)
  contact        Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  assignee       User?     @relation("FollowUpAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@index([followUpId])
  @@index([contactId])
  @@index([assigneeId])
  @@index([status])
  @@index([nextFollowUp])
}

model Survey {
  id              String    @id @default(cuid())
  userId          String
  title           String
  description     String?
  questions       String    @default("[]") // JSON array: [{ id, type, label, required, options?, placeholder? }]
  slug            String    @unique
  isActive        Boolean   @default(true)
  thankYouMessage String    @default("Thank you for your response!")
  responseCount   Int       @default(0)
  contactListId   String?
  status          String    @default("DRAFT") // DRAFT | ACTIVE | CLOSED
  sendCount       Int       @default(0)
  lastSentAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactList     ContactList?  @relation(fields: [contactListId], references: [id], onDelete: SetNull)
  responses       SurveyResponse[]

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@index([isActive])
  @@index([createdAt])
}

model SurveyResponse {
  id              String    @id @default(cuid())
  surveyId        String
  respondentName  String?
  respondentEmail String?
  respondentPhone String?
  answers         String    @default("{}") // JSON: { questionId: answer }
  rating          Int?
  contactId       String?
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime  @default(now())

  survey          Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
  @@index([contactId])
  @@index([rating])
  @@index([createdAt])
}

// ============================================
// TOOLS  DATA COLLECTION FORMS
// ============================================

model DataForm {
  id              String    @id @default(cuid())
  userId          String
  title           String
  description     String?
  fields          String    @default("[]")   // JSON: DataFormField[]
  slug            String    @unique
  status          String    @default("DRAFT") // DRAFT | ACTIVE | CLOSED
  thankYouMessage String    @default("Thank you for your submission!")
  responseCount   Int       @default(0)
  settings        String    @default("{}") // JSON: { notifyOnSubmit }
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  contactListId   String?
  sendCount       Int       @default(0)
  lastSentAt      DateTime?

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactList     ContactList?      @relation(fields: [contactListId], references: [id], onDelete: SetNull)
  submissions     DataFormSubmission[]

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@index([createdAt])
}

model DataFormSubmission {
  id              String    @id @default(cuid())
  formId          String
  data            String    @default("{}") // JSON: { fieldId: value }
  respondentName  String?
  respondentEmail String?
  respondentPhone String?
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime  @default(now())

  form            DataForm  @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([createdAt])
}

// ============================================
// TOOLS  EVENTS
// ============================================

model Event {
  id                  String    @id @default(cuid())
  userId              String
  title               String
  description         String?
  slug                String    @unique
  eventDate           DateTime
  endDate             DateTime?
  timezone            String    @default("UTC")
  venueName           String?
  venueAddress        String?
  isOnline            Boolean   @default(false)
  onlineUrl           String?
  coverImageUrl       String?
  mediaUrls           String    @default("[]")  // JSON array of image/video URLs
  registrationType    String    @default("rsvp") // rsvp | form | booking
  registrationFields  String    @default("[]")  // JSON: DataFormField[] (for form type)
  capacity            Int?
  registrationCount   Int       @default(0)
  ticketType          String    @default("free") // free | paid
  ticketPrice         Int?      // Price in cents
  ticketName          String?
  platformFeePercent  Int       @default(10)
  totalRevenueCents   Int       @default(0)
  totalRefundedCents  Int       @default(0)
  status              String    @default("DRAFT") // DRAFT | ACTIVE | CLOSED | CANCELLED
  ticketStyle         String    @default("classic") // classic | modern | elegant
  settings            String    @default("{}") // JSON: { thankYouMessage, requireApproval, showCapacity }
  contactListId       String?
  sendCount           Int       @default(0)
  lastSentAt          DateTime?
  landingPageId       String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactList         ContactList?      @relation(fields: [contactListId], references: [id], onDelete: SetNull)
  registrations       EventRegistration[]
  ticketOrders        TicketOrder[]

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@index([eventDate])
  @@index([createdAt])
}

model EventRegistration {
  id              String    @id @default(cuid())
  eventId         String
  contactId       String?
  name            String?
  email           String?
  phone           String?
  status          String    @default("registered") // registered | attended | cancelled | waitlisted
  rsvpResponse    String?   // attending | not_attending | maybe
  formData        String    @default("{}") // JSON: { fieldId: value }
  ticketCode      String    @unique
  ticketOrderId   String?
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime  @default(now())

  event           Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([contactId])
  @@index([ticketCode])
  @@index([status])
  @@index([createdAt])
}

model TicketOrder {
  id                    String    @id @default(cuid())
  eventId               String
  buyerName             String
  buyerEmail            String
  amountCents           Int
  platformFeeCents      Int
  organizerAmountCents  Int
  stripeSessionId       String    @unique
  stripePaymentIntentId String?
  status                String    @default("PENDING") // PENDING | COMPLETED | REFUNDED | PARTIALLY_REFUNDED
  refundedAmountCents   Int       @default(0)
  refundedAt            DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  event                 Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([stripeSessionId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// TEAM JOIN REQUESTS
// ============================================

model TeamJoinRequest {
  id          String    @id @default(cuid())
  teamId      String
  userId      String
  message     String?
  status      String    @default("PENDING") // PENDING | APPROVED | REJECTED
  reviewedBy  String?
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user        User      @relation("JoinRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([status])
}

// ============================================
// CONTENT MODERATION
// ============================================

model ContentFlag {
  id              String    @id @default(cuid())
  reporterUserId  String

  contentType     String    // "post" or "comment"
  postId          String?
  commentId       String?

  reason          String    // spam, harassment, hate_speech, nudity, violence, misinformation, other
  description     String?

  status          String    @default("pending") // pending, reviewed, dismissed, actioned
  reviewedBy      String?
  reviewedAt      DateTime?
  resolution      String?   // approved, removed, warned, suspended

  createdAt       DateTime  @default(now())

  reporter        User      @relation("ContentFlagsReported", fields: [reporterUserId], references: [id], onDelete: Cascade)
  post            Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment         Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([contentType, status])
  @@index([postId])
  @@index([commentId])
  @@index([reporterUserId])
}

model ModerationLog {
  id            String    @id @default(cuid())
  adminId       String
  contentType   String    // "post" or "comment"
  postId        String?
  commentId     String?
  userId        String?   // Content owner affected
  action        String    // approve, remove, warn, suspend
  reason        String?
  createdAt     DateTime  @default(now())

  @@index([adminId])
  @@index([postId])
  @@index([commentId])
  @@index([createdAt])
}

// ============================================
// E-COMMERCE (FLOWSHOP)
// ============================================

model Store {
  id                     String    @id @default(cuid())
  userId                 String    @unique
  name                   String
  slug                   String    @unique
  description            String?
  logoUrl                String?
  bannerUrl              String?

  // Business
  industry               String?
  currency               String    @default("USD")
  region                 String?
  country                String?

  // Theme (JSON: {template, colors: {primary, secondary, accent, background, text}, fonts: {heading, body}, layout})
  theme                  String    @default("{}")

  // Settings (JSON: {shipping, notifications, policies, codMaxAmount, codFee, autoCancel})
  settings               String    @default("{}")

  // Subscription
  ecomSubscriptionId     String?   // Stripe subscription ID
  ecomSubscriptionStatus String    @default("inactive") // active, inactive, cancelled, past_due, trialing
  ecomPlan               String    @default("basic")    // "basic" ($5/mo) or "pro" ($12/mo)

  // Stripe Connect (for receiving payments)
  stripeConnectAccountId String?   // Stripe Connect account ID
  stripeOnboardingComplete Boolean @default(false)
  platformFeePercent     Int       @default(5)  // FlowSmartly's cut (default 5%)
  platformFeesCollectedCents Int   @default(0) // Lifetime platform fees collected

  // Custom Domain
  customDomain           String?                         // e.g. "mybrandstore.com"
  freeDomainClaimed      Boolean   @default(false)       // Pro plan: has user claimed their free domain?

  // Free Trial (Basic plan, no card required)
  freeTrialStartedAt     DateTime?
  freeTrialEndsAt        DateTime?
  freeTrialRemindersSent String    @default("[]")        // JSON: ["day25","day28"]

  // Status
  isActive               Boolean   @default(false)
  setupComplete          Boolean   @default(false)

  // Denormalized stats
  productCount           Int       @default(0)
  orderCount             Int       @default(0)
  totalRevenueCents      Int       @default(0)

  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  deletedAt              DateTime?

  // Relations
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products               Product[]
  categories             ProductCategory[]
  orders                 Order[]
  drivers                DeliveryDriver[]
  paymentMethods         StorePaymentMethod[]
  domains                StoreDomain[]
  intelligenceReports    IntelligenceReport[]
  marketResearchReports  MarketResearchReport[]
  productFeeds           ProductFeed[]

  @@index([slug])
  @@index([userId])
  @@index([isActive])
}

model Product {
  id                  String    @id @default(cuid())
  storeId             String
  name                String
  slug                String
  description         String?
  shortDescription    String?

  // Categorization
  category            String?
  categoryId          String?
  tags                String    @default("[]") // JSON array

  // Pricing (cents)
  priceCents          Int
  comparePriceCents   Int?      // "was" price for discounts
  costCents           Int?      // cost price for profit tracking
  currency            String    @default("USD")

  // Images (JSON array: [{url, alt, position}])
  images              String    @default("[]")

  // Inventory
  trackInventory      Boolean   @default(false)
  quantity            Int       @default(0)
  lowStockThreshold   Int       @default(5)

  // Status
  status              String    @default("DRAFT") // DRAFT, ACTIVE, ARCHIVED

  // SEO
  seoTitle            String?
  seoDescription      String?

  // Denormalized stats
  viewCount           Int       @default(0)
  orderCount          Int       @default(0)
  revenueCents        Int       @default(0)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  deletedAt           DateTime?

  // Relations
  store               Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productCategory     ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  variants            ProductVariant[]
  competitorPrices    CompetitorPrice[]
  priceHistory        PriceHistory[]
  pricingRule         PricingRule?
  adCreativeVariants  AdCreativeVariant[]

  @@unique([storeId, slug])
  @@index([storeId])
  @@index([storeId, status])
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
}

model ProductVariant {
  id                  String    @id @default(cuid())
  productId           String
  name                String
  sku                 String?

  // Pricing
  priceCents          Int
  comparePriceCents   Int?

  // Options (JSON: {size: "L", color: "Red"})
  options             String    @default("{}")

  // Inventory
  quantity            Int       @default(0)
  imageUrl            String?

  isActive            Boolean   @default(true)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  product             Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
}

model ProductCategory {
  id                  String    @id @default(cuid())
  storeId             String
  name                String
  slug                String
  description         String?
  imageUrl            String?
  parentId            String?
  sortOrder           Int       @default(0)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  store               Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  parent              ProductCategory? @relation("CategoryChildren", fields: [parentId], references: [id])
  children            ProductCategory[] @relation("CategoryChildren")
  products            Product[]

  @@unique([storeId, slug])
  @@index([storeId])
  @@index([parentId])
}

model Order {
  id                  String    @id @default(cuid())
  storeId             String
  orderNumber         String    @unique // Format: ORD-2026-XXXX

  // Customer info
  customerName        String
  customerEmail       String
  customerPhone       String?
  buyerUserId         String?   // If buyer is a FlowSmartly user

  // Items (JSON: [{productId, variantId, name, quantity, priceCents, imageUrl}])
  items               String    @default("[]")

  // Totals (cents)
  subtotalCents       Int
  shippingCents       Int       @default(0)
  taxCents            Int       @default(0)
  totalCents          Int
  platformFeeCents    Int       @default(0)  // FlowSmartly's cut
  storeOwnerAmountCents Int     @default(0)  // Amount transferred to store owner
  currency            String    @default("USD")

  // Status
  status              String    @default("PENDING") // PENDING, CONFIRMED, PROCESSING, SHIPPED, DELIVERED, CANCELLED, REFUNDED

  // Payment
  paymentMethod       String?   // card, mobile_money, cod, bank_transfer
  paymentStatus       String    @default("pending") // pending, paid, failed, refunded
  paymentId           String?   // Stripe PI or mobile money ref

  // Shipping
  shippingAddress     String    @default("{}") // JSON: {name, line1, line2, city, state, zip, country}
  shippingMethod      String?
  trackingNumber      String?
  estimatedDelivery   DateTime?

  // Notes
  notes               String?
  cancelReason        String?

  // Ad attribution (UTM tracking for ROAS)
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?
  utmContent          String?
  adCampaignId        String?   // Direct link to AdCampaign
  referrer            String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  store               Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  deliveryAssignment  DeliveryAssignment?

  @@index([storeId])
  @@index([storeId, status])
  @@index([orderNumber])
  @@index([customerEmail])
  @@index([buyerUserId])
  @@index([createdAt])
  @@index([adCampaignId])
}

model DeliveryDriver {
  id                  String    @id @default(cuid())
  storeId             String
  name                String
  phone               String
  email               String?

  vehicleType         String    @default("bike") // bike, car, truck
  region              String?
  isActive            Boolean   @default(true)

  // Authentication token for driver location updates
  accessToken         String?   @unique

  // Current location
  currentLatitude     Float?
  currentLongitude    Float?
  lastLocationUpdate  DateTime?

  status              String    @default("available") // available, busy, offline

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  store               Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  assignments         DeliveryAssignment[]

  @@index([storeId])
  @@index([storeId, status])
  @@index([isActive])
  @@index([accessToken])
}

model DeliveryAssignment {
  id                    String    @id @default(cuid())
  orderId               String    @unique
  driverId              String

  status                String    @default("assigned") // assigned, picked_up, in_transit, delivered, failed

  // Addresses (JSON)
  pickupAddress         String    @default("{}")
  deliveryAddress       String    @default("{}")

  estimatedDeliveryTime DateTime?
  actualDeliveryTime    DateTime?

  // Proof of delivery (JSON: {photoUrl, signature, notes})
  proofOfDelivery       String    @default("{}")
  customerConfirmed     Boolean   @default(false)

  // Location history (JSON: [{lat, lng, timestamp}])
  locationHistory       String    @default("[]")

  // COD
  codAmountCents        Int?
  codCollected          Boolean   @default(false)

  notes                 String?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  order                 Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  driver                DeliveryDriver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([driverId])
  @@index([status])
}

model StorePaymentMethod {
  id                  String    @id @default(cuid())
  storeId             String
  methodType          String    // card, mobile_money, cod, bank_transfer, apple_pay, google_pay
  provider            String?   // stripe, flutterwave, paystack, mpesa, orange_money, mtn_momo, wave
  isActive            Boolean   @default(true)
  config              String    @default("{}") // JSON: provider-specific settings
  region              String?   // Restrict to specific region

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  store               Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, methodType, provider])
  @@index([storeId])
}

//  Intelligence Models 

model CompetitorPrice {
  id              String   @id @default(cuid())
  productId       String
  competitorName  String
  competitorUrl   String?
  priceCents      Int
  currency        String   @default("USD")
  inStock         Boolean  @default(true)
  lastChecked     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model PriceHistory {
  id         String   @id @default(cuid())
  productId  String
  priceCents Int
  source     String   // "manual", "ai_suggestion", "competitor_match"
  reason     String?
  createdAt  DateTime @default(now())

  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, createdAt])
}

model PricingRule {
  id          String    @id @default(cuid())
  productId   String    @unique
  strategy    String    // "beat_lowest", "match_average", "premium", "demand", "margin_target"
  config      String    @default("{}") // JSON: {marginPercent, offsetCents, minPriceCents, maxPriceCents, roundTo}
  isActive    Boolean   @default(true)
  lastApplied DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// ============================================
// INTELLIGENCE REPORTS
// ============================================

model IntelligenceReport {
  id                 String    @id @default(cuid())
  storeId            String
  triggeredBy        String    // "manual" | "cron"
  status             String    @default("running") // "running" | "completed" | "failed"
  competitorData     String?   // JSON
  trendData          String?   // JSON
  seoData            String?   // JSON
  recommendationData String?   // JSON
  summary            String?   // JSON: { competitorsFound, avgSeoScore, trendHighlights[], topRecommendations[] }
  creditsUsed        Int       @default(0)
  errorMessage       String?
  startedAt          DateTime  @default(now())
  completedAt        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  store              Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, createdAt])
}

model MarketResearchReport {
  id          String   @id @default(cuid())
  storeId     String
  data        String   // JSON: MarketResearchResult
  creditsUsed Int      @default(0)
  createdAt   DateTime @default(now())

  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, createdAt])
}

// ============================================
// STORE DOMAINS
// ============================================

model StoreDomain {
  id                String    @id @default(cuid())
  storeId           String
  userId            String
  domainName        String    @unique  // "mybrandstore.com"
  tld               String             // "com", "store", "shop", etc.

  // OpenSRS
  registrarOrderId  String?            // OpenSRS order ID
  registrarStatus   String    @default("pending") // pending, active, expired, transferred

  // Cloudflare
  cloudflareZoneId  String?            // Cloudflare zone ID
  sslStatus         String    @default("pending") // pending, active, failed

  // Billing
  isFree            Boolean   @default(false)  // True if claimed via Pro plan
  purchasePriceCents Int      @default(0)      // What user paid
  renewalPriceCents  Int      @default(0)      // Annual renewal cost to user
  costCents          Int      @default(0)      // Our cost from OpenSRS

  // Config
  whoisPrivacy      Boolean   @default(true)
  autoRenew         Boolean   @default(true)
  nameservers       String    @default("[]")   // JSON array
  dnsRecords        String    @default("[]")   // JSON of configured records

  // Status
  isPrimary         Boolean   @default(false)  // Primary domain for this store
  isConnected       Boolean   @default(false)  // BYOD: user brought their own domain
  expiresAt         DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  store             Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@index([userId])
  @@index([domainName])
}

//  Product Feeds (Google Shopping, Facebook Catalog, TikTok) 
model ProductFeed {
  id           String    @id @default(cuid())
  storeId      String
  platform     String    // "google_shopping" | "facebook_catalog" | "tiktok"
  feedUrl      String?   // Public URL to generated feed file
  feedFormat   String    // "xml" | "json" | "csv"
  productCount Int       @default(0)
  lastSyncedAt DateTime?
  status       String    @default("pending") // "pending" | "synced" | "error"
  errorMessage String?
  settings     String    @default("{}")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  store        Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, platform])
  @@index([storeId])
}

//  AI Ad Creative Variants 
model AdCreativeVariant {
  id          String   @id @default(cuid())
  productId   String
  platform    String   // "google" | "facebook" | "tiktok" | "flowsmartly"
  headline    String
  description String
  ctaText     String   @default("Shop Now")
  imageUrl    String?
  score       Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

// ============================================
// AI VOICE STUDIO
// ============================================

model VoiceProfile {
  id                String    @id @default(cuid())
  userId            String
  name              String
  type              String    @default("preset")
  gender            String?
  accent            String?
  style             String?
  openaiVoice       String?
  elevenLabsVoiceId String?
  openaiVoiceId     String?
  openaiConsentId   String?
  sampleUrl         String?
  isDefault         Boolean   @default(false)
  lastUsedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  generations VoiceGeneration[]

  @@index([userId])
}

model VoiceGeneration {
  id             String   @id @default(cuid())
  userId         String
  voiceProfileId String?
  script         String
  scriptSource   String   @default("manual")
  gender         String?
  accent         String?
  style          String?
  openaiVoice    String?
  speed          Float    @default(1.0)
  isClonedVoice  Boolean  @default(false)
  audioUrl       String?
  durationMs     Int?
  fileSizeBytes  Int?
  status         String   @default("PENDING")
  errorMessage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  voiceProfile VoiceProfile? @relation(fields: [voiceProfileId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
}

// ============================================
// WHATSAPP BUSINESS INTEGRATION
// ============================================

model WhatsAppConversation {
  id                String    @id @default(cuid())
  userId            String
  socialAccountId   String    // Links to SocialAccount (WhatsApp Business number)
  customerPhone     String    // Customer's phone number (E.164 format)
  customerName      String?   // Customer's name from WhatsApp profile
  customerAvatarUrl String?
  lastMessageAt     DateTime  @default(now())
  lastMessageText   String?   // Preview of last message
  unreadCount       Int       @default(0)
  status            String    @default("open") // "open" | "closed" | "archived"
  assignedTo        String?   // User ID if assigned to team member
  tags              String    @default("[]") // JSON array of tags
  metadata          String    @default("{}") // JSON metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  socialAccount     SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  messages          WhatsAppMessage[]

  @@index([userId])
  @@index([socialAccountId])
  @@index([customerPhone])
  @@index([status])
}

model WhatsAppMessage {
  id                 String   @id @default(cuid())
  conversationId     String
  whatsappMessageId  String?  // WhatsApp message ID from API
  direction          String   // "inbound" | "outbound"
  messageType        String   // "text" | "image" | "video" | "document" | "audio" | "location" | "template"
  content            String   // Text content or media URL
  mediaUrl           String?  // For images, videos, documents
  mimeType           String?
  fileName           String?
  thumbnailUrl       String?
  caption            String?
  templateName       String?  // If sent via template
  status             String   @default("pending") // "pending" | "sent" | "delivered" | "read" | "failed"
  errorCode          String?
  errorMessage       String?
  metadata           String   @default("{}") // JSON metadata
  timestamp          DateTime @default(now())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  conversation       WhatsAppConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([whatsappMessageId])
  @@index([direction])
  @@index([status])
  @@index([timestamp])
}

model WhatsAppTemplate {
  id                 String   @id @default(cuid())
  userId             String
  socialAccountId    String
  name               String   // Template name (lowercase, no spaces)
  category           String   // "MARKETING" | "UTILITY" | "AUTHENTICATION"
  language           String   @default("en") // Language code
  status             String   @default("PENDING") // "PENDING" | "APPROVED" | "REJECTED"
  headerType         String?  // "text" | "image" | "video" | "document"
  headerText         String?
  headerMediaUrl     String?
  bodyText           String   // Template body with {{1}} placeholders
  footerText         String?
  buttons            String?  // JSON array of buttons
  templateConfig     String?  // Full template JSON config
  whatsappTemplateId String?  // WhatsApp template ID
  usageCount         Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  socialAccount      SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@index([socialAccountId])
  @@index([status])
}

model WhatsAppAutomation {
  id              String   @id @default(cuid())
  userId          String
  socialAccountId String
  name            String
  description     String?
  isActive        Boolean  @default(true)
  triggerType     String   // "keyword" | "new_conversation" | "inbound_message" | "missed_chat" | "schedule"
  triggerConfig   String?  // JSON config for trigger
  actionType      String   // "send_message" | "send_template" | "assign_to" | "add_tag" | "webhook"
  actionValue     String?  // Action value (e.g., message text)
  actionConfig    String?  // JSON configuration
  priority        Int      @default(0)
  usageCount      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([socialAccountId])
  @@index([isActive])
  @@index([triggerType])
}
